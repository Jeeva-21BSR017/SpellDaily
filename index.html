<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spell Daily</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Pattaya&family=Poppins:wght@400;600;700&family=Ultra&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        /* CRITICAL MOBILE OVERRIDES - INJECTED FOR STABILITY */
        @media (max-width: 900px) {

            /* Stack Columns */
            .accomplishments-wrapper .acc-columns {
                flex-direction: column !important;
                gap: 50px !important;
            }

            .accomplishments-wrapper .acc-col {
                width: 100% !important;
            }

            /* Container Adjustments */
            .acc-bg {
                padding: 40px 15px !important;
                height: auto !important;
            }

            /* Force Visuals containment */
            .streak-visuals {
                height: 120px !important;
                margin-bottom: 30px !important;
                /* Space for text */
                width: 100% !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
            }

            /* Icons - Centered & Contained */
            .icon-fire,
            .icon-bullseye {
                position: absolute !important;
                top: 0 !important;
                left: 50% !important;
                right: auto !important;
                width: 100px !important;
                transform: translateX(-80%) !important;
                /* Keep overlap logic */
            }

            /* Numbers - Centered & Contained */
            .streak-num {
                position: relative !important;
                left: 50% !important;
                top: 25px !important;
                font-size: 3.5rem !important;
                transform: translateX(-25%) !important;
                /* Overlap right */
                margin-bottom: 0 !important;
            }

            .acc-text-block {
                margin-top: 10px !important;
                font-size: 0.9rem !important;
            }
        }
    </style>
</head>

<body>

    <div class="app-container">

        <!-- Logo -->
        <div class="logo-wrapper">
            <img src="assets/logo.svg" alt="Spell Daily" class="app-logo">
        </div>

        <div class="section-wrapper summary-wrapper">
            <div class="summary-split-container">
                <!-- Card 1: Overall -->
                <div class="summary-card">
                    <div class="card-tape-wrapper">
                        <img src="assets/overall.svg" alt="Overall" class="card-tape-img">
                    </div>
                    <div class="summary-content-col">
                        <div class="number-large" id="practiced-count">--</div>
                        <img src="assets/words_practiced.svg" alt="Words Practiced" class="summary-img-label">
                    </div>
                </div>

                <!-- Card 2: This Month -->
                <div class="summary-card">
                    <div class="card-tape-wrapper">
                        <img src="assets/this_month.svg" alt="This Month" class="card-tape-img">
                    </div>
                    <div class="summary-content-row">
                        <div class="summary-sub-col">
                            <div class="number-large" id="correct-count">--</div>
                            <img src="assets/words_practicedthis_month.svg" alt="Words Correct"
                                class="summary-img-label">
                        </div>
                        <div class="summary-sub-col">
                            <div class="number-large" id="missed-count">--</div>
                            <img src="assets/words_missedthis_month.svg" alt="Words Missed" class="summary-img-label">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Word Bank Section -->
        <div class="section-wrapper wordbank-wrapper">
            <div class="section-header-container">
                <img src="assets/word_bank.svg" alt="Word Bank" class="section-header-img header-tape-shadow">
            </div>

            <div class="card-container wordbank-bg">
                <div class="word-grid" id="word-grid">
                    <!-- Words injected here -->
                </div>
                <div class="wordbank-footer">
                    Marked in red : incorrect answers on the 1<sup> st</sup> attempt
                </div>
            </div>
        </div>

        <!-- Bottom Row -->
        <div class="bottom-row">

            <!-- Accomplishments -->
            <div class="section-wrapper accomplishments-wrapper">
                <div class="section-header-container">
                    <img src="assets/accomplishments.svg" alt="Accomplishments"
                        class="section-header-img header-tape-shadow">
                </div>
                <!-- Accomplishments Container -->
                <div class="card-container acc-bg">
                    <div class="acc-columns">
                        <!-- Left: Streak -->
                        <div class="acc-col">
                            <div class="streak-visuals">
                                <img src="assets/fire.svg" alt="Fire" class="icon-visual icon-fire">
                                <div class="number-large streak-num" id="streak-days">--</div>
                            </div>
                            <!-- Text moved outside/below visuals -->
                            <div class="acc-text-block">
                                <span id="streak-days-text">--</span> - <span id="streak-msg">--</span>
                            </div>
                        </div>

                        <!-- Right: Bullseye -->
                        <div class="acc-col">
                            <div class="streak-visuals">
                                <img src="assets/bullseye.svg" alt="Bullseye" class="icon-visual icon-bullseye">
                                <div class="number-large streak-num" id="bullseye-count">--</div>
                            </div>
                            <div class="acc-text-block">
                                A bullseye means your child completed the day's tasks with zero mistakes.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cup Section (Replaces Insights) -->
            <div class="cup-wrapper">
                <img src="assets/cup.svg" alt="Trophy" class="cup-img">
            </div>

        </div>

        <footer class="app-footer">
            <!-- Using bottomtext_container.svg if available, otherwise just styled pill -->
            <!-- The user didn't mention this specifically but "all space box" implies it. -->
            <!-- I'll stick to CSS pill for footer text as it's cleaner unless SVG is needed. -->
            <div class="footer-content">
                Note for Parents : Even mastered words can be misspelled. Regular practice and celebrating small wins
                help maintain progress!
            </div>
        </footer>

    </div>

    <!-- Load Data Script -->
    <script src="data.js"></script>

    <!-- Main Logic -->
    <script>
        // Render Function
        document.addEventListener('DOMContentLoaded', () => {
            // Use the global appData object loaded from data.js
            const data = appData;

            // Summary
            const practiced = data.summary.practiced;
            const correct = data.summary.correctFirstAttempt;
            const missed = practiced - correct; // Automatically calculate missed

            document.getElementById('practiced-count').textContent = practiced;
            document.getElementById('correct-count').textContent = correct;
            document.getElementById('missed-count').textContent = missed;

            // Word Bank
            const grid = document.getElementById('word-grid');
            data.wordBank.forEach(w => {
                const div = document.createElement('div');
                div.textContent = w.word;
                div.className = w.correct ? 'word-item' : 'word-item incorrect';
                grid.appendChild(div);
            });

            // Accomplishments
            document.getElementById('streak-days').textContent = data.user.streakDays;

            // Bullseye Logic (Mapping 'correctFirstAttempt' to bullseye for now)
            // In a real app this might be a separate specific 'perfect days' counter
            document.getElementById('bullseye-count').textContent = data.summary.correctFirstAttempt;

            document.getElementById('streak-days-text').textContent = data.user.streakDays + " days";
            document.getElementById('streak-msg').textContent = data.user.streakMessage;

            <!-- Removed old Rank/Insights logic as UI replaced it -->
        });
    </script>

    <!-- Page 2: Progress Section (Appended for Single Report Flow) -->
    <!-- Ideally this is a separate "page" visual block -->
    <div class="page-break-marker"></div> <!-- For PDF logic later -->

    <div class="app-container progress-page-container" id="page-2-container">
        <!-- Progress Header -->
        <div class="section-wrapper progress-header-wrapper">
            <div class="section-header-container">
                <img src="assets/progress_heading.svg" alt="Progress" class="progress-header-img">
            </div>
        </div>

        <!-- Progress Content Container -->
        <div class="progress-list" id="progress-container">
            <!-- Content will be injected by JS -->
        </div>
    </div>

    <!-- Scripts for Page 2 Logic -->
    <script src="Page2/data.js"></script>
    <script>
        // Render Page 2 Content
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('progress-container');
            if (!container) return;

            let htmlContent = '';

            // Ensure progressData is available (from Page2/data.js)
            if (typeof progressData !== 'undefined') {
                progressData.forEach(row => {
                    if (row.type === 'full') {
                        // Render Full Width Card
                        const cardData = row.cards[0];
                        htmlContent += `
                            <div class="progress-card">
                                <div class="progress-table">
                                    <div class="table-row header-row">
                                        ${cardData.headers.map(h => `<div class="table-cell">${h}</div>`).join('')}
                                    </div>
                                    <div class="table-row word-row">
                                        ${cardData.words.map(w => `<div class="table-cell ${w.correct ? 'correct' : 'incorrect'}">${w.text}</div>`).join('')}
                                    </div>
                                </div>
                                ${cardData.footer ? `<div class="card-footer-text">${cardData.footer}</div>` : ''}
                            </div>
                        `;
                    } else if (row.type === 'split') {
                        // Render Split Row
                        htmlContent += `<div class="progress-split-row">`;

                        row.cards.forEach(cardData => {
                            htmlContent += `
                                <div class="progress-card split-card">
                                    <div class="progress-table">
                                        <div class="table-row header-row">
                                            ${cardData.headers.map(h => `<div class="table-cell">${h}</div>`).join('')}
                                        </div>
                                        <div class="table-row word-row">
                                            ${cardData.words.map(w => `<div class="table-cell ${w.correct ? 'correct' : 'incorrect'}">${w.text}</div>`).join('')}
                                        </div>
                                    </div>
                                </div>
                            `;
                        });

                        htmlContent += `</div>`;
                        if (row.footer) {
                            htmlContent += `<div class="split-footer-text">${row.footer}</div>`;
                        }
                    }
                });

                // Add Footer Note
                if (typeof footerNoteText !== 'undefined') {
                    htmlContent += `
                        <div class="footer-note">
                            ${footerNoteText}
                        </div>
                    `;
                }
            }

            container.innerHTML = htmlContent;
        });
    </script>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Floating Download Button -->
    <button id="download-btn" onclick="downloadPDF()">Download Report</button>

    <style>
        #download-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 12px 24px;
            background-color: #fff;
            color: #8C52FF;
            border: 2px solid #8C52FF;
            border-radius: 50px;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            transition: all 0.3s ease;
        }

        #download-btn:hover {
            background-color: #8C52FF;
            color: #fff;
            transform: translateY(-2px);
        }

        /* Visual separation on screen */
        .page-break-marker {
            height: 50px;
            width: 100%;
        }
    </style>

    <script>
        async function downloadPDF() {
            const btn = document.getElementById('download-btn');
            btn.style.display = 'none'; // Hide button

            try {
                const { jsPDF } = window.jspdf;
                // A4 dimensions in mm: 210 x 297
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();

                // 1. Create a merged logic wrapper
                const mergedContainer = document.createElement('div');
                Object.assign(mergedContainer.style, {
                    position: 'fixed',
                    left: '-9999px',
                    top: '0',
                    width: '1200px', // Desktop width
                    backgroundColor: '#8C52FF',
                    display: 'flex',
                    flexDirection: 'column',
                    alignItems: 'center',
                    gap: '40px',
                    padding: '40px',
                    zIndex: '-999'
                });

                // 2. Clone Content
                const page1Orig = document.querySelector('.app-container');
                const page2Orig = document.getElementById('page-2-container');

                if (page1Orig) mergedContainer.appendChild(page1Orig.cloneNode(true));
                if (page2Orig) mergedContainer.appendChild(page2Orig.cloneNode(true));

                // FIX: Force Header Overlap for PDF Capture
                // html2canvas sometimes struggles with negative margins in flexbox.
                // We manually pull them closer in the clone.
                const headers = mergedContainer.querySelectorAll('.section-header-container');
                headers.forEach(header => {
                    header.style.marginBottom = '-45px'; // Increased negative margin
                    header.style.position = 'relative';
                    header.style.zIndex = '100'; // Ensure on top
                });

                document.body.appendChild(mergedContainer);

                // 3. Capture
                const canvas = await html2canvas(mergedContainer, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#8C52FF',
                    logging: false,
                    windowWidth: 1200
                });

                document.body.removeChild(mergedContainer);

                // 4. Print
                const imgData = canvas.toDataURL('image/png');
                const imgProps = pdf.getImageProperties(imgData);
                const imgHeightInPdf = (imgProps.height * pdfWidth) / imgProps.width;

                let heightLeft = imgHeightInPdf;
                let position = 0;
                let pageCount = 0;

                while (heightLeft > 0) {
                    if (pageCount > 0) pdf.addPage();
                    pdf.setFillColor('#8C52FF');
                    pdf.rect(0, 0, pdfWidth, pdfHeight, 'F');

                    pdf.addImage(imgData, 'PNG', 0, position, pdfWidth, imgHeightInPdf);
                    heightLeft -= pdfHeight;
                    position -= pdfHeight;
                    pageCount++;
                }

                pdf.save('SpellDaily_Report.pdf');

            } catch (err) {
                console.error("PDF generation failed:", err);
                alert("Failed to generate PDF.");
            } finally {
                btn.style.display = 'block';
            }
        }
    </script>
</body>

</html>